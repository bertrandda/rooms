<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Sockets</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link type="text/css" rel="stylesheet" href="../css/client.css" media="screen, handheld" />
    <link href="https://fonts.googleapis.com/css?family=Teko" rel="stylesheet">
    <script src='../js/palette.js'></script>
    <script src="/socket.io/socket.io.js"></script>
</head>

<body>
    <h1 id="title"></h2>
        <div id="messages-history"></div>
        <div id="div-send">
            <input id="message-input" autocomplete="off" type="text" onkeypress="return onPressEnter(event)">
            <input id="send-message" value="Send" type="button" onclick="send()">
        </div>
        <script>
            let room = 'Room1';
            let socket = io.connect('/', { query: `room=${room}` });
            let id;
            let color;

            socket.on('init', (data) => {
                id = data.socketId;
            });

            socket.on('join', (data) => {
                room = data.room;
                if (id == data.socketId) {
                    color = palette.randomColor();
                    document.getElementById('title').textContent = room;
                    document.getElementById('messages-history').innerHTML = '';
                }
            })

            socket.on('fromServer', (data) => {
                const message = data.message;
                const messagesHistory = document.getElementById('messages-history');
                if (data.sender == id) {
                    messagesHistory.innerHTML += `<p class="mine message" style="background-color: ${palette.get(color, '300')}; color: ${palette.getText(color, '300')}">${message}</p>`;
                } else {
                    messagesHistory.innerHTML += `<p class="message server" style="background-color: ${palette.get(color, '600')}; color: ${palette.getText(color, '600')}">${message}</p>`;
                }
                messagesHistory.scrollTop = messagesHistory.scrollHeight;
            });

            socket.on('warning', (data) => {
                console.log(data.message);
            });

            socket.on('disconnect', () => {
                console.log('Socket disconnected');
                // TODO: Display again login page
            });

            function onPressEnter(event) {
                if (event.keyCode == 13) {
                    send();
                    return false;
                }
            }

            function send() {
                let element = document.getElementById('message-input');
                socket.emit('toServer', element.value);
                element.value = '';
            }
        </script>
</body>

</html>